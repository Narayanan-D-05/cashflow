sequenceDiagram
    autonumber
    
    actor User
    participant MerchantApp as Merchant App UI
    participant CashflowUI as Cashflow Subscription UI
    participant Backend as CashFlow402 API (Backend)
    participant Blockchain as BCH ChipNet (Electrum)
    
    User->>MerchantApp: 1. Click "Subscribe to AI Agent"
    MerchantApp->>CashflowUI: 2. Redirect (No Active Token)
    
    rect rgb(30, 41, 59)
        note right of User: Step 1: Session Creation
        CashflowUI->>Backend: POST /subscription/create-session
        Backend-->>CashflowUI: Returns: subscriberAddress, WIF, contractAddress, depositSats
        CashflowUI-->>User: Displays Subscriber Address to fund
    end
    
    rect rgb(30, 41, 59)
        note right of User: Step 2: Off-chain Funding
        User->>Blockchain: Transfer tBCH to subscriberAddress (via Faucet/Wallet)
        Blockchain-->>User: UTXO Confirmed
    end
    
    rect rgb(30, 41, 59)
        note right of User: Step 3: Covenant Activation
        CashflowUI->>Backend: POST /subscription/auto-fund (w/ subscriberWif & contractAddress)
        Backend->>Blockchain: Build & broadcast Genesis TX (Creates Mutable NFT)
        Blockchain-->>Backend: Returns txid & NFT tokenCategory
        Backend-->>CashflowUI: Sub Activated (Returns tokenCategory)
    end
    
    CashflowUI->>MerchantApp: 4. Redirect locally with `?tokenCategory=hex`
    MerchantApp-->>User: AI Chat UI Unlocked
    
    rect rgb(30, 41, 59)
        note right of User: Step 4: Gated Service Usage
        User->>MerchantApp: Send AI Prompt
        MerchantApp->>Backend: GET /api/subscription/data (Header: X-Subscription-Token)
        Backend->>Backend: verify status & deduct API cost from internal `usageMeter`
        Backend-->>MerchantApp: 200 OK (Allowed)
        MerchantApp-->>User: Display AI Response
    end
    
    rect rgb(30, 41, 59)
        note right of User: Step 5: Merchant Claims Funds
        MerchantApp->>Backend: POST /merchant/claim-all (Triggered by Merchant Admin)
        Backend->>Backend: Calculate total consumed sats
        Backend->>Blockchain: Broadcast CashScript Claim TX (Signed w/ Merchant WIF)
        Blockchain-->>Backend: Sweep funds to MERCHANT_ADDRESS & update NFT state
        Backend-->>MerchantApp: Claim Success confirmation
    end
