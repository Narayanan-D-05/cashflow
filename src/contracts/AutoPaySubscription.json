{
  "contractName": "AutoPaySubscription",
  "constructorInputs": [
    {
      "name": "merchantPkh",
      "type": "bytes20"
    },
    {
      "name": "subscriberPkh",
      "type": "bytes20"
    },
    {
      "name": "intervalBlocks",
      "type": "int"
    },
    {
      "name": "maxSats",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "claim",
      "inputs": [
        {
          "name": "merchantPk",
          "type": "pubkey"
        },
        {
          "name": "merchantSig",
          "type": "sig"
        },
        {
          "name": "pendingSats",
          "type": "int"
        }
      ]
    },
    {
      "name": "cancel",
      "inputs": [
        {
          "name": "subscriberPk",
          "type": "pubkey"
        },
        {
          "name": "subscriberSig",
          "type": "sig"
        }
      ]
    }
  ],
  "bytecode": "OP_4 OP_PICK OP_0 OP_NUMEQUAL OP_IF OP_6 OP_ROLL OP_6 OP_PICK OP_CHECKSIGVERIFY OP_5 OP_ROLL OP_HASH160 OP_OVER OP_EQUALVERIFY OP_INPUTINDEX OP_UTXOTOKENCOMMITMENT OP_DUP OP_4 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_4 OP_SPLIT OP_NIP OP_BIN2NUM OP_TXLOCKTIME OP_ROT OP_5 OP_ROLL OP_ADD OP_GREATERTHANOREQUAL OP_VERIFY OP_5 OP_PICK OP_0 OP_GREATERTHAN OP_VERIFY OP_DUP OP_6 OP_PICK OP_ADD OP_4 OP_ROLL OP_LESSTHANOREQUAL OP_VERIFY OP_INPUTINDEX OP_UTXOVALUE dc05 OP_OVER OP_7 OP_PICK OP_2 OP_PICK OP_ADD OP_GREATERTHANOREQUAL OP_VERIFY OP_ROT OP_6 OP_PICK OP_ADD OP_TXLOCKTIME OP_4 OP_NUM2BIN OP_SWAP OP_4 OP_NUM2BIN OP_CAT OP_ROT OP_6 OP_PICK OP_SUB OP_ROT OP_SUB OP_0 OP_OUTPUTBYTECODE OP_INPUTINDEX OP_UTXOBYTECODE OP_EQUALVERIFY OP_0 OP_OUTPUTVALUE OP_NUMEQUALVERIFY OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_INPUTINDEX OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_1 OP_OUTPUTBYTECODE 76a914 OP_ROT OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_1 OP_OUTPUTVALUE OP_3 OP_ROLL OP_NUMEQUAL OP_NIP OP_NIP OP_ELSE OP_4 OP_ROLL OP_1 OP_NUMEQUALVERIFY OP_5 OP_ROLL OP_5 OP_PICK OP_CHECKSIGVERIFY OP_4 OP_ROLL OP_HASH160 OP_2 OP_PICK OP_EQUALVERIFY OP_INPUTINDEX OP_UTXOVALUE dc05 OP_0 OP_OUTPUTBYTECODE 76a914 OP_5 OP_ROLL OP_CAT 88ac OP_CAT OP_EQUALVERIFY OP_0 OP_OUTPUTVALUE OP_ROT OP_ROT OP_SUB OP_GREATERTHANOREQUAL OP_VERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_EQUAL OP_NIP OP_NIP OP_NIP OP_ENDIF",
  "source": "pragma cashscript ^0.12.0;\r\n\r\n/**\r\n * AutoPaySubscription — Metered Billing Edition\r\n *\r\n * A non-custodial metered-billing covenant on BCH using CashTokens (mutable NFT).\r\n *\r\n * The contract UTXO holds:\r\n *   - BCH balance    — credits deposited by the subscriber\r\n *   - Mutable NFT    — on-chain state tracking total sats consumed\r\n *\r\n * ── NFT commitment layout (8 bytes) ──────────────────────────────────────────\r\n *   bytes [0..3]  lastClaimBlock  (int32 little-endian) — block of last merchant claim\r\n *   bytes [4..7]  totalConsumed   (int32 little-endian) — cumulative sats consumed by API calls\r\n *                                                          (updated each claim, never decreases)\r\n *\r\n * ── Constructor parameters (baked into script bytecode, immutable) ────────────\r\n *   merchantPkh     — merchant's P2PKH hash (20 bytes)\r\n *   subscriberPkh   — subscriber's P2PKH hash (20 bytes)\r\n *   intervalBlocks  — minimum BCH blocks between claims (e.g. 1 = can claim each block)\r\n *   maxSats         — ceiling cap: merchant can never claim more than maxSats total ever\r\n *                     (safety parameter; set to total deposit for uncapped metered billing)\r\n *\r\n * ── Spending paths ─────────────────────────────────────────────────────────────\r\n *   claim(pendingSats) — merchant claims exactly what users consumed since last claim\r\n *   cancel()           — subscriber terminates and recovers full remaining balance\r\n */\r\ncontract AutoPaySubscription(\r\n    bytes20 merchantPkh,\r\n    bytes20 subscriberPkh,\r\n    int     intervalBlocks,\r\n    int     maxSats\r\n) {\r\n    /**\r\n     * claim(pendingSats)\r\n     *\r\n     * Merchant claims exactly the amount consumed by API calls since the last claim.\r\n     * `pendingSats` is provided by the trusted CashFlow402 backend from usageMeter.\r\n     *\r\n     * The NFT commitment is updated to record the new cumulative total consumed.\r\n     *\r\n     * Required tx structure:\r\n     *   inputs:   [0] this contract UTXO  (BCH + mutable NFT)\r\n     *   outputs:  [0] this contract again (reduced BCH + updated NFT commitment)\r\n     *             [1] merchant P2PKH      (exactly pendingSats)\r\n     *\r\n     * tx.locktime MUST be set to current block height — enforces the interval.\r\n     */\r\n    function claim(pubkey merchantPk, sig merchantSig, int pendingSats) {\r\n        // ── 1. Verify merchant identity ───────────────────────────────────────\r\n        require(checkSig(merchantSig, merchantPk));\r\n        require(hash160(merchantPk) == merchantPkh);\r\n\r\n        // ── 2. Enforce minimum interval ───────────────────────────────────────\r\n        bytes nftData      = tx.inputs[this.activeInputIndex].nftCommitment;\r\n        int lastClaimBlock = int(nftData.split(4)[0]);\r\n        int totalConsumed  = int(nftData.split(4)[1]);\r\n\r\n        require(tx.locktime >= lastClaimBlock + intervalBlocks);\r\n\r\n        // ── 3. Validate claim amount ──────────────────────────────────────────\r\n        // Must be > 0 (no empty claims) and ≤ maxSats safety ceiling\r\n        require(pendingSats > 0);\r\n        require(totalConsumed + pendingSats <= maxSats);\r\n\r\n        // ── 4. Contract must have enough funds ────────────────────────────────\r\n        int inputValue = tx.inputs[this.activeInputIndex].value;\r\n        int minerFee   = 1500;\r\n        require(inputValue >= pendingSats + minerFee);\r\n\r\n        // ── 5. Build updated NFT commitment ───────────────────────────────────\r\n        //    New lastClaimBlock = tx.locktime\r\n        //    New totalConsumed  = previous + pendingSats\r\n        int newTotalConsumed = totalConsumed + pendingSats;\r\n        bytes newCommitment  = bytes4(tx.locktime) + bytes4(newTotalConsumed);\r\n\r\n        // ── 6. Output 0: contract self-output, reduced balance, updated NFT ───\r\n        int contractBalance = inputValue - pendingSats - minerFee;\r\n        require(tx.outputs[0].lockingBytecode == tx.inputs[this.activeInputIndex].lockingBytecode);\r\n        require(tx.outputs[0].value           == contractBalance);\r\n        require(tx.outputs[0].nftCommitment   == newCommitment);\r\n        require(tx.outputs[0].tokenCategory   == tx.inputs[this.activeInputIndex].tokenCategory);\r\n\r\n        // ── 7. Output 1: merchant receives exactly pendingSats ────────────────\r\n        require(tx.outputs[1].lockingBytecode == new LockingBytecodeP2PKH(merchantPkh));\r\n        require(tx.outputs[1].value           == pendingSats);\r\n    }\r\n\r\n    /**\r\n     * cancel()\r\n     *\r\n     * Subscriber terminates the subscription and recovers the full remaining balance.\r\n     * Any unconsumed credits are returned to the subscriber's wallet.\r\n     * The mutable NFT is destroyed (not forwarded) — subscription ends permanently.\r\n     *\r\n     * Required tx structure:\r\n     *   inputs:   [0] this contract UTXO\r\n     *   outputs:  [0] subscriber P2PKH  (full remaining balance minus miner fee)\r\n     */\r\n    function cancel(pubkey subscriberPk, sig subscriberSig) {\r\n        // ── 1. Verify subscriber identity ────────────────────────────────────\r\n        require(checkSig(subscriberSig, subscriberPk));\r\n        require(hash160(subscriberPk) == subscriberPkh);\r\n\r\n        // ── 2. Return remaining balance to subscriber ─────────────────────────\r\n        int inputValue = tx.inputs[this.activeInputIndex].value;\r\n        int minerFee   = 1500;\r\n\r\n        require(tx.outputs[0].lockingBytecode == new LockingBytecodeP2PKH(subscriberPkh));\r\n        require(tx.outputs[0].value           >= inputValue - minerFee);\r\n\r\n        // ── 3. Enforce NFT destruction (subscriber output carries no token)\r\n        require(tx.outputs[0].tokenCategory == 0x);\r\n    }\r\n}\r\n",
  "debug": {
    "bytecode": "5479009c63567a5679ad557aa97888c0cf76547f75817c547f7781c57b557a93a269557900a06976567993547aa169c0c602dc05785779527993a2697b567993c554807c54807e7b5679947b9400cdc0c78800cc9d00d28800d1c0ce8851cd0376a9147b7e0288ac7e8851cc537a9c777767547a519d557a5579ad547aa9527988c0c602dc0500cd0376a914557a7e0288ac7e8800cc7b7b94a26900d1008777777768",
    "sourceMap": "49:4:87:5;;;;;51:25:51:36;;:38::48;;:8::51:1;52:24:52:34:0;;:16::35:1;:39::50:0;:8::52:1;55:39:55:60:0;:29::75:1;56:33:56:40:0;:47::48;:33::49:1;:::52;:29::53;57:33:57:40:0;:47::48;:33::49:1;:::52;:29::53;59:16:59:27:0;:31::45;:48::62;;:31:::1;:16;:8::64;63:16:63:27:0;;:30::31;:16:::1;:8::33;64:16:64:29:0;:32::43;;:16:::1;:47::54:0;;:16:::1;:8::56;67:35:67::0;:25::63:1;68::68:29:0;69:16:69:26;:30::41;;:44::52;;:30:::1;:16;:8::54;74:31:74:44:0;:47::58;;:31:::1;75:38:75:49:0;:31::50:1;;:60::76:0;:53::77:1;;:31;78:30:78:40:0;:43::54;;:30:::1;:57::65:0;:30:::1;79:27:79:28:0;:16::45:1;:59::80:0;:49::97:1;:8::99;80:27:80:28:0;:16::35:1;:8::66;81:27:81:28:0;:16::43:1;:8::64;82:27:82:28:0;:16::43:1;:59::80:0;:49::95:1;:8::97;85:27:85:28:0;:16::45:1;:49::86:0;:74::85;:49::86:1;;;:8::88;86:27:86:28:0;:16::35:1;:49::60:0;;:8::62:1;49:4:87:5;;;100::114::0;;;;102:25:102:38;;:40::52;;:8::55:1;103:24:103:36:0;;:16::37:1;:41::54:0;;:8::56:1;106:35:106::0;:25::63:1;107::107:29:0;109:27:109:28;:16::45:1;:49::88:0;:74::87;;:49::88:1;;;:8::90;110:27:110:28:0;:16::35:1;:49::59:0;:62::70;:49:::1;:16;:8::72;113:27:113:28:0;:16::43:1;:47::49:0;:8::51:1;100:4:114:5;;;28:0:115:1",
    "logs": [],
    "requires": [
      {
        "ip": 13,
        "line": 51
      },
      {
        "ip": 18,
        "line": 52
      },
      {
        "ip": 37,
        "line": 59
      },
      {
        "ip": 42,
        "line": 63
      },
      {
        "ip": 50,
        "line": 64
      },
      {
        "ip": 61,
        "line": 69
      },
      {
        "ip": 83,
        "line": 79
      },
      {
        "ip": 86,
        "line": 80
      },
      {
        "ip": 89,
        "line": 81
      },
      {
        "ip": 94,
        "line": 82
      },
      {
        "ip": 102,
        "line": 85
      },
      {
        "ip": 108,
        "line": 86
      },
      {
        "ip": 119,
        "line": 102
      },
      {
        "ip": 125,
        "line": 103
      },
      {
        "ip": 137,
        "line": 109
      },
      {
        "ip": 144,
        "line": 110
      },
      {
        "ip": 149,
        "line": 113
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.12.1"
  },
  "updatedAt": "2026-02-21T19:12:22.546Z"
}